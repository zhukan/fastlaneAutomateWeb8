# PRD 6.0 - 下架排查功能

**版本**: 6.0  
**创建日期**: 2025-12-30  
**最后更新**: 2026-01-01  
**状态**: ✅ 已上线  
**负责人**: AI助手  

---

## 📋 文档说明

本文档记录**下架排查功能**的需求讨论过程和技术实现方案。

---

## 🎯 需求背景

### 现状
目前系统有两个独立的监控功能：
1. **下架监控**（App Removal Monitor）- 自动检测我的app是否被下架，实时监控工具
2. **目标包监控**（Target App Monitor）- 监控竞品包
3. **关联对比功能**（5.0）- 将"我的包"和"目标包"进行对比

### 新需求
需要一个**事后分析工具**：
- 当某个app已经被下架后
- 需要从明道云数据库获取该app的操作记录
- 分析操作记录，排查可能导致下架的原因

### 功能定位差异

| 功能 | 类型 | 时机 | 目的 | 数据来源 |
|------|------|------|------|----------|
| **下架监控** | 实时监控工具 | 持续进行 | 自动检测app是否被下架 | iTunes API / App Store Connect API |
| **下架排查** | 事后分析工具 | app已下架后 | 通过操作记录排查下架原因 | 明道云操作记录 |

---

## ✅ 已实现功能

### 核心功能（v6.0.0）

#### 1. 数据同步服务
- ✅ 从明道云同步1373条下架App记录
- ✅ 完整的操作时间线（发布+更新记录）
- ✅ **增量同步**：只同步最近1天新增的App（< 30秒）
- ✅ **全量同步**：同步所有下架App数据（~20分钟）
- ✅ 自动定时同步：每天凌晨3点自动执行增量同步
- ✅ 同步日志记录：完整的同步历史和状态追踪

#### 2. 数据库表结构
创建了4张核心数据表：
- ✅ `removed_apps` - 下架App基本信息（1373条记录）
- ✅ `operation_records` - 操作记录（包含发布和更新记录）
- ✅ `ri_developer_accounts` - 开发者账号信息
- ✅ `removal_investigation_sync_logs` - 同步日志
- ✅ `app_removal_analysis` - 下架原因分析记录

#### 3. 前端界面
- ✅ 侧边栏"下架排查"独立入口（位于"设置"上方）
- ✅ 下架App列表页
  - 搜索功能（App名称、Bundle ID）
  - 分页显示（每页20条）
  - 操作记录数量统计
  - 最后同步时间显示
- ✅ App详情页（操作时间线）
  - 完整的操作时间线展示
  - 时间倒序排列（最新的在上）
  - 区分操作类型（首次发布🚀/更新🔄）
  - 关键信息展示：时间、版本号、广告代码版本、操作人、发布地点、备注
  - 账号信息卡片
  - 下架原因分析和猜测模块 ⭐新增

#### 4. 关键字段展示
根据PRD要求，成功展示以下重要字段：
- ✅ **版本号** - 来自发布和更新记录
- ✅ **广告代码版本** ⭐ - 来自生产发布表和更新任务表
- ✅ **生产人/发布人** ⭐ - 显示操作人员姓名
- ✅ **发布地点** ⭐ - 显示发布位置（公司/家等）
- ✅ **备注信息** - 显示每次操作的备注

#### 5. 下架原因分析功能 ⭐
新增独立的下架原因分析模块：
- ✅ 在每个App的详情页中，提供"APP 下架原因分析和猜测"文本框
- ✅ 支持记录和保存操作员对下架原因的分析
- ✅ 显示创建人、更新人和时间戳
- ✅ 支持多次编辑和更新
- ✅ 数据持久化存储在 `app_removal_analysis` 表中

#### 6. API接口
实现了完整的REST API：
- ✅ `POST /api/removal-investigation/sync` - 全量同步
- ✅ `POST /api/removal-investigation/sync-incremental` - 增量同步 ⭐
- ✅ `GET /api/removal-investigation/apps` - 获取App列表（支持分页和搜索）
- ✅ `GET /api/removal-investigation/apps/:bundleId/timeline` - 获取操作时间线
- ✅ `GET /api/removal-investigation/sync-status` - 获取同步状态
- ✅ `GET /api/removal-investigation/apps/:bundleId/analysis` - 获取分析内容 ⭐
- ✅ `POST /api/removal-investigation/apps/:bundleId/analysis` - 保存分析内容 ⭐

#### 7. 性能优化
- ✅ **增量同步**：从20分钟优化到30秒内（速度提升40倍）
- ✅ 数据库索引优化：`bundle_id`、`operation_time` 等关键字段
- ✅ 分页加载：避免一次加载过多数据

### 数据规模
- 📊 **下架App数量**：1373个
- 📊 **发布记录**：2827条（来自App生产发布表）
- 📊 **更新记录**：986条（来自App更新任务表）
- 📊 **开发者账号**：数百个

### 技术实现
- 🔧 **后端**：Express.js + TypeScript + Supabase
- 🔧 **前端**：Next.js + React + TailwindCSS + shadcn/ui
- 🔧 **数据库**：PostgreSQL (Supabase)
- 🔧 **数据源**：明道云 V3 API（支持两个不同应用的访问）
- 🔧 **定时任务**：node-cron（每天凌晨3点）

---

## 🎨 界面设计

### 位置
- **导航栏位置**：侧边栏"设置"菜单项**上方**
- **独立模块**：前后端完全独立的新模块

### 整体布局（✅已实现）

**主界面 - 列表页**：
```
┌─────────────────────────────────────────────────────────────┐
│  下架排查                                                      │
│  分析app操作记录，排查下架原因                                  │
├─────────────────────────────────────────────────────────────┤
│  [⚡ 增量同步]  [🔄 全量同步]  最后同步：2025-12-31 03:00    │
│  [🔍 搜索: App名称/Bundle ID...]                             │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 左侧：App列表                  │ 右侧：时间线详情           ││
│  │                                │                         ││
│  │ 📱 奇智AI写作                   │ 🚀 首次发布 - v1.0.0      ││
│  │ com.qizhi.ai                  │ 2025-11-20 10:00       ││
│  │ 账号: account@example.com     │ 操作人: 王五             ││
│  │ 下架: 12-25 10:30             │ 发布地点: 公司           ││
│  │ 操作记录: 15条                 │ 广告代码: v3.2.1         ││
│  │                                │                         ││
│  │ 📱 智能翻译助手                 │ 🔄 更新 - v2.5.3         ││
│  │ com.qizhi.trans               │ 2025-12-20 14:20       ││
│  │ 账号: account2@example.com    │ 操作人: 张三             ││
│  │ 下架: 12-22 15:20             │ 广告代码: v3.2.2         ││
│  │ 操作记录: 8条                  │ 备注: 修复bug，优化性能   ││
│  │                                │                         ││
│  │ [上一页] [下一页]              │ [刷新数据]               ││
│  │ 显示 1-20 / 共 1373 个         │                         ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

**详情页 - 操作时间线**：
```
┌─────────────────────────────────────────────────────────────┐
│  奇智AI写作 - 操作时间线                     [← 返回列表]     │
│  Bundle ID: com.qizhi.ai  |  下架时间: 2025-12-25 10:30     │
├─────────────────────────────────────────────────────────────┤
│  📊 账号信息                                                  │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 开发者账号: account@example.com                       │   │
│  │ 账号来源: 🔴 代理11号（账号提供者）                    │   │
│  │ 账号状态: ⚠️ 账号被关停                                │   │
│  │ 账号到期: 2025-12-20（已过期）                         │   │
│  │ 注册地: 中国  |  产品数: 12个                          │   │
│  │ 质量标记: 🔴 秒挂过、没开广告被下架                     │   │
│  └──────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  📝 APP 下架原因分析和猜测 ⭐                                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ [文本框：记录下架原因的分析和猜测]                      │   │
│  │                                                        │   │
│  │ [保存] 创建人: 张三 | 更新人: 李四 | 更新时间: 刚刚     │   │
│  └──────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  📅 操作时间线（共15条记录）                                  │
│                                                               │
│  ┌─ 2025-12-25 10:30 ──────────────────────────────────┐   │
│  │ ❌ APP被下架                                          │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌─ 2025-12-20 14:20 ──────────────────────────────────┐   │
│  │ 🔄 更新任务 - v2.5.3                                  │   │
│  │ 状态: 正式包上架                                       │   │
│  │ 发布人: 张三                                           │   │
│  │ 📍 发布地点: 公司                                      │   │
│  │ 📢 广告代码版本: v3.2.2                                │   │
│  │ 💬 备注: 修复bug，优化性能                             │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌─ 2025-11-20 10:00 ──────────────────────────────────┐   │
│  │ 🚀 首次发布 - v1.0.0                                  │   │
│  │ 状态: 正式包上架                                       │   │
│  │ 生产人: 王五                                           │   │
│  │ 📍 发布地点: 公司                                      │   │
│  │ 📢 广告代码版本: v3.2.1                                │   │
│  │ 发布类型: 正式包                                       │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 💬 需求讨论

### ✅ 已确认内容

#### 1. 功能定位
- ✅ **名称**：下架排查
- ✅ **类型**：事后分析工具（非实时监控）
- ✅ **触发时机**：app已经被下架后
- ✅ **核心目的**：通过操作记录排查下架原因
- ✅ **数据来源**：明道云数据库的操作记录
- ✅ **模块独立性**：前后端完全独立的新模块

#### 2. 导航位置
- ✅ 位置：侧边栏"设置"菜单项上方
- ✅ 独立入口

---

### ❓ 待讨论问题

#### 问题1：明道云的操作记录数据 ✅ 已确认

**取数逻辑**：
1. 从明道云"账号上的产品"表（`643418197f0301fb51750f00`）筛选App状态为"APP被下架"的记录
2. 获取每条下架记录的`bundle_id`（字段ID: `64b3a82fa75368cd24c99d8d`）
3. 使用`bundle_id`分别查询以下两个表：
   - **"App生产发布"表**（ID: `65612ddfc96f80bfabe5df2e`，在"App工厂"应用下）
   - **"App更新任务"表**（ID: `640ab32a56058b3df8803af2`，在"二维奇智"应用下）
4. 按照发布时间从早到晚排序，形成完整的操作时间线

**数据关联示意图**：
```
账号上的产品表（App状态="APP被下架"）
  ↓ 获取 bundle_id + 关联账号
  ├─→ 苹果开发者账号表（通过账号关联）
  │    └─ 获取账号状态、到期时间、质量标记等
  │
  ├─→ App生产发布表（通过bundle_id关联）
  │    └─ 获取首次发布记录、发布时间、发布人等
  │
  └─→ App更新任务表（通过bundle_id关联）
       └─ 获取所有更新记录、更新时间、版本号等

合并 + 按时间排序
  ↓
完整操作时间线 + 账号风险信息
```

**关键字段映射**：

| 用途 | 工作表 | 字段名 | 字段ID |
|------|--------|--------|--------|
| **App基本信息** ||||
| 筛选条件 | 账号上的产品 | App状态 | `64366ef856462b8747391a08` |
| 下架状态Key | - | APP被下架 | `e766bfba-d23d-42a3-a9b8-b01139344bde` |
| 关联键 | 账号上的产品 | Bundle id | `64b3a82fa75368cd24c99d8d` |
| 下架时间 | 账号上的产品 | APP被下架时间 | `645c67ec7861415e0edf3565` |
| App名称 | 账号上的产品 | App名称 | `64341ac46d6df8983a7f7af3` |
| App ID | 账号上的产品 | appid | `643418197f0301fb51750f02` |
| 开发者账号 | 账号上的产品 | 开发者账号 | `64369d9b05108c17907e6a00` |
| 账号关联 | 账号上的产品 | 苹果开发者账号 | `64341940fa601169896433f6` |
| **账号信息** ||||
| 账号邮箱 | 苹果开发者账号 | 开发者账号 | `640adea9c04c8d453ff1ce53` |
| 账号来源 | 苹果开发者账号 | 账号来源（Relation） | `6435534e05108c17907c9766` |
| 账号来源名称 | 苹果开发者账号 | 账号来源名称（Lookup）⭐ | `64f0050bfe6380ec34433b31` |
| 账号状态 | 苹果开发者账号 | 账号状态 | `6432921f1a26322d585e393b` |
| 到期时间 | 苹果开发者账号 | 账号到期时间 | `6502c1411329a664bacf97d1` |
| 关停时间 | 苹果开发者账号 | 账号关停时间 | `652f23b6b2073276dba1975b` |
| 质量标记 | 苹果开发者账号 | 账号质量 | `6539fe639c47bf4d041672be` |
| 注册地 | 苹果开发者账号 | 注册地 | `6642e102a048b0f22a27df53` |
| 产品数量 | 苹果开发者账号 | 账号上的产品数量 | `657eb6aa8d3800f9a1b01c13` |
| **账号来源详情** ||||
| 来源名称 | 合作人员 | 名称 | `64340cf71c0252233e96336d` |
| 来源类型 | 合作人员 | 类型 | `643552ce56462b87473791dd` |
| 业务类型 | 合作人员 | 业务 | `66ac98ddbd1de0f461171568` |
| **操作记录** ||||
| 发布状态 | App更新任务 | 发布状态 | `6436a3aa56462b8747397762` |
| 提审时间 | App更新任务 | 提交审核时间 | `641ee11b56350b78574cf7c1` |
| 版本号 | App更新任务 | 版本号 | `641f033f5815faac860d15de` |
| 发布人 | App更新任务 | 发布人 | `64366cddcb42afb8b5e79583` |
| 备注 | App更新任务 | 备注 | `6415a35b543f450698f389a9` |
| 创建时间 | - | 创建时间（系统字段） | `ctime` |

---

#### 问题2：排查的使用场景 ✅ 已明确

**主要场景**：单个app排查（核心功能）
- 查看下架app列表
- 点击进入单个app的操作时间线
- 分析从发布到下架的完整过程

**可选场景**：批量对比分析（阶段4）
- 多选下架app进行横向对比
- 识别共同特征和规律
- 降低未来下架风险

**决策**：
- ✅ 阶段1-2优先实现单个排查功能
- ⏸️ 阶段4根据实际使用情况决定是否开发批量对比

---

#### 问题3：展示维度和重要性 ✅ 已明确

**核心展示维度**（阶段1-2必须实现）：

1. **时间线视图**（最高优先级）
   - ✅ 显示从发布到下架的完整时间轴
   - ✅ 每个操作节点显示：时间、类型、版本、状态、操作人、备注
   - ✅ 按时间倒序排列（最新的在上）
   - ✅ 区分操作类型（首次发布/更新）

2. **基本信息展示**
   - ✅ App名称、Bundle ID、App ID
   - ✅ 下架时间
   - ✅ 开发者账号
   - ✅ 操作记录总数

**辅助展示维度**（阶段3可选）：

3. **自动分析数据**
   - 存活时长（从发布到下架）
   - 更新频率（平均多少天更新一次）
   - 最后更新到下架的时间间隔

4. **统计数据**
   - 总下架数量
   - 本月下架数量
   - 平均存活时长

**高级展示维度**（阶段4可选）：
5. **批量对比视图**
6. **风险识别和预警**
7. **数据可视化图表**

**决策**：
- ✅ 优先实现时间线视图（维度A）
- ✅ 其他维度根据开发进度逐步添加

---

#### 问题4：筛选和查询 ✅ 已明确

**必须的筛选条件**（阶段2）：
- ✅ 搜索框：按App名称或Bundle ID搜索
- ✅ 排序：按下架时间排序（默认最新的在前）

**可选的筛选条件**（阶段3）：
- 按时间范围筛选（本月/近3个月/全部）
- 按开发者账号筛选
- 按存活时长排序

**默认显示范围**：
- 显示所有下架的app
- 按下架时间倒序（最近下架的在前）
- 每页20条记录

---

#### 问题5：分析功能 ✅ 已明确

**阶段3实现**（基础分析）：
- ✅ 自动计算数据
  - 存活时长
  - 更新频率
  - 最后更新到下架的间隔
- ✅ 导出报告
  - 导出单个app的操作记录（Excel/PDF）
  - 包含完整时间线和统计数据

**阶段4考虑**（高级分析）：
- 风险识别：基于历史数据识别高风险操作模式
- 手动标注：用户可以标注某个操作为可疑原因
- 批量对比：多个app的横向对比分析

**AI辅助分析**：
- ⏸️ 暂不考虑，等积累足够数据后再评估
- 可以考虑基于规则的简单分析（如：频繁更新、特定版本号等）

---

## 📊 数据需求

### 核心数据实体

#### 1. 下架的App（Removed Apps）
**来源**：明道云 "账号上的产品" 工作表（`643418197f0301fb51750f00`）

**筛选条件**：
- App状态（`64366ef856462b8747391a08`）= "APP被下架"（Key: `e766bfba-d23d-42a3-a9b8-b01139344bde`）

**关键字段**：
- App名称（`64341ac46d6df8983a7f7af3`）
- Bundle ID（`64b3a82fa75368cd24c99d8d`）- **用作关联键**
- App ID（`643418197f0301fb51750f02`）
- 开发者账号（`64369d9b05108c17907e6a00`）- Lookup字段
- 苹果开发者账号（`64341940fa601169896433f6`）- **关联字段，用于获取账号详情**
- APP被下架时间（`645c67ec7861415e0edf3565`）
- App状态（`64366ef856462b8747391a08`）

#### 2. App生产发布记录（Production Release Records）
**来源**：明道云 "App生产发布" 工作表（ID: `65612ddfc96f80bfabe5df2e`）
- ✅ **位置**：在"App工厂"应用下
- ✅ **API访问方式**：明道云 V3 API
  - 端点：`POST https://api.mingdao.com/v3/app/worksheets/{worksheet_id}/rows/list`
  - 认证：Header传递 `HAP-Appkey` 和 `HAP-Sign`
  - 验证日期：2025-12-31
  - 记录总数：2827条

**关联方式**：通过Bundle ID关联到"账号上的产品"表

**关键字段**（✅已验证可读）：
- Bundle id（`64b168be624fef0d46c1105b`）- **关联键** - 文本
- App名称（`64b168be624fef0d46c11058`）- 文本
- 版本号（`64b168be624fef0d46c11068`）⭐ - 文本
- 生产人（`6810850325726172e2468246`）⭐ - 关联字段（用户）- 格式：`[{"accountId":"...", "fullname":"..."}]`
- 发布地点（`64cdf3e1784014033c3348d8`）⭐ - 选项字段 - 示例值：`公司`
- 广告代码版本（`6655a94ca87340a9754f7c41`）⭐ - 选项字段 - 格式：`[{"key":"...", "value":"..."}]`
- 发布时间（`64b168be624fef0d46c1106b`）- 日期时间 - **操作时间基准**
- 第一次提审时间（`64b168be624fef0d46c1106e`）- 日期时间
- 发布人（`64b3ead57658fd2098b7e311`）- 关联字段（用户）
- 状态（`64b168be624fef0d46c11054`）- 选项字段
- 发布类型（`64b168be624fef0d46c11055`）- 选项字段
- 开发者账号（`64b168be624fef0d46c1105d`）- 文本
- App Store ID（`64b168be624fef0d46c11059`）- 文本
- 苹果开发者账号管理记录（`65826dea543abda6dd15fe05`）- 关联字段 - 关联到开发者账号表
- 调试完成时间（`64b3effda75368cd24c9b97c`）- 日期时间
- 打包上传时间（`64b3effda75368cd24c9b97d`）- 日期时间
- 备注（`64b168be624fef0d46c11069`）- 文本
- 创建时间（`ctime`）- 系统字段

#### 3. App更新记录（Update Records）
**来源**：明道云 "App更新任务" 工作表（`640ab32a56058b3df8803af2`）
- ✅ **位置**：在"二维奇智"应用下
- ✅ **API访问方式**：明道云 V3 API
  - 端点：`POST https://api.mingdao.com/v3/app/worksheets/{worksheet_id}/rows/list`
  - 认证：Header传递 `HAP-Appkey` 和 `HAP-Sign`
  - 验证日期：2025-12-31
  - 记录总数：986条

**关联方式**：通过"账号上的产品"字段（`6437343d6e173a52dea04494`）关联

**关键字段**（✅已验证可读）：
- 正式包名称（`64097218d867a5c9c89b043b`）- 标题字段 - 文本
- 关联的"账号上的产品"（`6437343d6e173a52dea04494`）- **关联键** - 关联字段
- 发布状态（`6436a3aa56462b8747397762`）- 下拉选项
- 发布人（`64366cddcb42afb8b5e79583`）- 关联字段（用户）
- 版本号（`641f033f5815faac860d15de`）⭐ - 文本
- 广告代码版本（`6943850dee1f6a984701555f`）⭐ - 下拉选项 - 格式：`[{"key":"...", "value":"..."}]`
- 提交审核时间（`641ee11b56350b78574cf7c1`）- 日期时间 - **操作时间基准**
- 调试完成时间（`641ee11b56350b78574cf7c0`）- 日期时间
- 打包上传时间（`6420f9639c0aa3e8b33d0f63`）- 日期时间
- 备注（`6415a35b543f450698f389a9`）- 文本
- 创建时间（`ctime`）- 系统字段 - 日期时间
- 最近修改时间（`utime`）- 系统字段 - 日期时间

#### 4. 苹果开发者账号信息（Developer Account Info）
**来源**：明道云 "苹果开发者账号" 工作表（`640adea9c04c8d453ff1ce52`）

**关联方式**：从"账号上的产品"表的"苹果开发者账号"字段（`64341940fa601169896433f6`）关联

**关键字段**：

**基本信息**：
- 开发者账号（`640adea9c04c8d453ff1ce53`）- 账号邮箱
- 账号状态（`6432921f1a26322d585e393b`）⭐ 重要
- 账号来源（`6435534e05108c17907c9766`）⭐⭐ 非常重要 - Relation字段，关联到"合作人员"表
- 账号来源名称（`64f0050bfe6380ec34433b31`）⭐⭐ 非常重要 - Lookup字段，直接显示名称
- 账号开通时间（`6434fb461c0252233e97750c`）
- 账号到期时间（`6502c1411329a664bacf97d1`）⭐ 重要
- 账号关停时间（`652f23b6b2073276dba1975b`）⭐ 重要
- 注册地（`6642e102a048b0f22a27df53`）
- 备注（`64329ea386146fa66f5eb732`）

**账号来源详细信息**（从"合作人员"表获取）：
- 来源名称（`64340cf71c0252233e96336d`）- 如"代理11号"、"自注册"等
- 来源类型（`643552ce56462b87473791dd`）- 账号提供者、经常合作、开发等
- 业务类型（`66ac98ddbd1de0f461171568`）- 二维奇智、云谷电商
- 常用发布地（`68382693b51ad402ceb396de`）

**用途说明**：
- 账号来源可以快速识别账号质量和风险等级
- 不同来源的账号下架率可能差异很大
- 可以用于统计分析，优化账号采购策略

**风险标记**：
- 账号质量（`6539fe639c47bf4d041672be`）⭐⭐ 非常重要
  - 多选字段，包含历史问题标记：
  - 秒挂过、other过、长时间没进审核、长时间审核没出结果、没开广告被下架、被清词

**统计数据**：
- 账号上的产品数量（`657eb6aa8d3800f9a1b01c13`）
- 发布次数（`6597a809d350581690b0aedb`）
- 发布失败（`658270428d3800f9a1b46fb7`）

**用途说明**：
- 账号信息可以帮助分析下架是否与账号异常相关
- 特别是账号状态、到期时间、质量标记等字段
- 可以识别高风险账号和常见问题模式

---

## 🔧 技术实现方案

### 数据同步流程

#### 阶段1：从明道云同步到Supabase

```
步骤1: 获取下架app列表
  ↓
调用明道云API - get_record_list
  worksheet_id: 643418197f0301fb51750f00
  filter: App状态 = "APP被下架"
  ↓
获取结果：下架app列表（含bundle_id、下架时间、账号关联ID等）
  ↓
步骤2: 获取账号信息
  ↓
对每个app的账号关联ID：
  调用明道云API - get_record_details
  worksheet_id: 640adea9c04c8d453ff1ce52
  row_id: 账号记录ID
  ↓
获取账号状态、到期时间、质量标记等
  ↓
合并数据
  ↓
存入Supabase: removal_analysis 表（新表）
```

**Supabase表设计（✅已实现）**：

1. **removed_apps** - 下架App基本信息
```sql
CREATE TABLE removed_apps (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  bundle_id TEXT NOT NULL UNIQUE,
  app_name TEXT,
  app_id TEXT,
  hap_product_row_id TEXT, -- 明道云"账号上的产品"表的记录ID
  developer_account_id UUID REFERENCES ri_developer_accounts(id),
  developer_account_email TEXT,
  removal_date TIMESTAMPTZ,
  app_status TEXT,
  operation_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_removed_apps_bundle ON removed_apps(bundle_id);
CREATE INDEX idx_removed_apps_removal_date ON removed_apps(removal_date DESC);
CREATE INDEX idx_removed_apps_developer ON removed_apps(developer_account_id);
```

2. **ri_developer_accounts** - 开发者账号信息
```sql
CREATE TABLE ri_developer_accounts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  hap_account_row_id TEXT UNIQUE, -- 明道云账号记录ID
  account_email TEXT,
  account_status TEXT,
  account_source TEXT, -- 账号来源名称（如"代理11号"）⭐
  account_source_type JSONB, -- 账号来源类型（数组）
  account_expiry_date TIMESTAMPTZ,
  account_closed_date TIMESTAMPTZ,
  account_region TEXT,
  account_quality_issues JSONB, -- 账号质量标记（数组）
  account_product_count INTEGER,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_ri_accounts_hap_id ON ri_developer_accounts(hap_account_row_id);
CREATE INDEX idx_ri_accounts_email ON ri_developer_accounts(account_email);
```

#### 阶段2：获取操作记录

```
对于每个下架的app（bundle_id）：
  ↓
并行查询：
  ├─→ 查询"App生产发布"表
  │    调用明道云API: get_record_list
  │    worksheet_id: 65612ddfc96f80bfabe5df2e（App工厂应用）
  │    filter: Bundle ID = bundle_id
  │    ↓
  │    获取首次发布记录
  │
  └─→ 查询"App更新任务"表
       调用明道云API: get_record_list
       worksheet_id: 640ab32a56058b3df8803af2
       filter: 关联的"账号上的产品" = 该app记录ID
       ↓
       获取所有更新记录
  ↓
合并结果 + 按时间排序
  ↓
存入Supabase: removal_operation_logs 表（新表）
```

3. **operation_records** - 操作记录（发布和更新）
```sql
CREATE TABLE operation_records (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  app_id UUID NOT NULL REFERENCES removed_apps(id) ON DELETE CASCADE,
  bundle_id TEXT NOT NULL,
  operation_type TEXT NOT NULL, -- 'PRODUCTION_RELEASE' | 'UPDATE'
  operation_time TIMESTAMPTZ,
  version TEXT,
  ad_code_version TEXT, -- 广告代码版本⭐
  status TEXT,
  operator_name TEXT,
  release_location TEXT, -- 发布地点⭐
  remarks TEXT,
  hap_record_id TEXT, -- 明道云记录ID
  raw_data JSONB, -- 完整的明道云记录
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_operation_records_app ON operation_records(app_id);
CREATE INDEX idx_operation_records_bundle ON operation_records(bundle_id);
CREATE INDEX idx_operation_records_time ON operation_records(operation_time DESC);
CREATE INDEX idx_operation_records_type ON operation_records(operation_type);
```

4. **removal_investigation_sync_logs** - 同步日志
```sql
CREATE TABLE removal_investigation_sync_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  sync_type TEXT NOT NULL, -- 'FULL' | 'INCREMENTAL'
  triggered_by TEXT NOT NULL, -- 'MANUAL' | 'AUTO' | 'SYSTEM'
  status TEXT NOT NULL, -- 'RUNNING' | 'SUCCESS' | 'FAILED'
  start_time TIMESTAMPTZ NOT NULL,
  end_time TIMESTAMPTZ,
  apps_synced INTEGER,
  operations_synced INTEGER,
  error_message TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_sync_logs_time ON removal_investigation_sync_logs(start_time DESC);
CREATE INDEX idx_sync_logs_status ON removal_investigation_sync_logs(status);
```

5. **app_removal_analysis** - 下架原因分析 ⭐
```sql
CREATE TABLE app_removal_analysis (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  bundle_id TEXT UNIQUE NOT NULL,
  analysis_content TEXT,
  created_by TEXT,
  updated_by TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_app_removal_analysis_bundle ON app_removal_analysis(bundle_id);
```

### 前端展示逻辑

#### 主界面：下架app列表

```typescript
// 数据结构
interface RemovedApp {
  bundleId: string;
  appName: string;
  appId: string;
  developerAccount: string;
  removalDate: Date;
  operationCount: number; // 操作记录数量
  
  // 账号信息
  accountStatus: string; // 账号状态
  accountExpiryDate: Date | null; // 账号到期时间
  accountQualityIssues: string[]; // 质量标记数组
  accountRegion: string; // 注册地
}

// API端点
GET /api/removal-analysis/apps
  ?page=1
  &pageSize=20
  &sortBy=removal_date
  &order=desc
```

#### 详情页：操作时间线

```typescript
// 操作记录数据结构
interface OperationLog {
  id: string;
  operationType: 'production_release' | 'update';
  operationTime: Date;
  version: string;
  status: string;
  operator: string;
  remarks: string;
  rawData: any;
}

// 账号信息数据结构
interface AccountInfo {
  accountEmail: string;
  accountSource: string; // 账号来源名称，如"代理11号"⭐
  accountSourceType: string[]; // 账号来源类型，如['账号提供者', '经常合作']
  accountStatus: string;
  accountExpiryDate: Date | null;
  accountClosedDate: Date | null;
  accountRegion: string;
  accountQualityIssues: string[]; // ['秒挂过', 'other过']
  accountProductCount: number;
}

// 完整详情数据
interface RemovalDetail {
  app: RemovedApp;
  account: AccountInfo;
  operations: OperationLog[];
}

// API端点
GET /api/removal-analysis/operations/:bundleId
  ?sortBy=operation_time
  &order=asc
  
// 返回: RemovalDetail
```

### 同步策略（✅已实现）

#### 1. 增量同步（推荐）⭐
**触发方式**：
- 点击"⚡ 增量同步"按钮（手动触发）

**同步内容**：
- 同步所有下架App（使用upsert自动处理新增和更新）
- 只为"明道云有但Supabase没有"的App同步操作记录
- 识别策略：查找操作记录数量为0的App

**性能**：
- ⚡ **速度**：< 30秒（通常只有几个新增App）
- 📊 **API调用**：约20次
- 💰 **资源消耗**：低

**适用场景**：
- 发现App下架后手动触发
- 快速同步新增下架App
- 事后排查分析

#### 2. 全量同步（备用）
**触发方式**：
- 点击"🔄 全量同步"按钮（次按钮）

**同步内容**：
- 同步所有1373条下架App记录
- 同步所有操作记录（发布+更新）

**性能**：
- ⏱️ **速度**：20-30分钟
- 📊 **API调用**：约2746次
- 💰 **资源消耗**：高

**适用场景**：
- 首次使用（初始化数据）
- 数据修复（发现数据不一致）
- 定期校验（每周或每月）

#### 3. 性能对比
| 同步类型 | 数据量 | API调用 | 耗时 | 适用场景 |
|---------|-------|---------|------|----------|
| **增量同步** | ~10个App | ~20次 | **< 30秒** | 日常使用（推荐）⭐ |
| **全量同步** | 1373个App | ~2746次 | **20-30分钟** | 初始化/修复 |

**性能优化**：
- ✅ 增量同步使用时间窗口过滤（`created_at >= 1天前`）
- ✅ 使用upsert避免重复插入
- ✅ 数据库索引优化
- ✅ 同步日志完整记录（类型、触发者、状态、耗时）

#### 4. 自动定时同步
- ⚠️ **已禁用**：下架排查是事后分析工具，不需要自动同步
- 🔄 **使用方式**：手动点击"增量同步"按钮触发
- 📝 **工作流程**：发现下架 → 记录明道云 → 手动增量同步 → 分析

---

## 🎬 用户交互场景

### 场景1：查看下架app列表
**用户故事**：我想看到所有被下架的app，了解整体情况

**操作流程**：
1. 点击侧边栏"下架排查"菜单
2. 进入下架app列表页面
3. 默认按下架时间倒序显示
4. 可以看到每个app的基本信息和操作记录数量

**界面设计**：
```
┌─────────────────────────────────────────────────────────────┐
│  下架排查                                                      │
│  分析app操作记录，排查下架原因                                  │
├─────────────────────────────────────────────────────────────┤
│  [🔄 同步下架数据]  最后同步：2025-12-30 10:30               │
│  [🔍 搜索: App名称/Bundle ID...]                             │
├─────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────────┐ │
│  │ App名称        │Bundle ID      │下架时间  │操作记录 │  │ │
│  ├────────────────────────────────────────────────────────┤ │
│  │ 奇智AI写作     │com.qizhi.ai   │12-25    │15条    │➡ │ │
│  │ 账号: 账号A     │               │10:30    │        │  │ │
│  ├────────────────────────────────────────────────────────┤ │
│  │ 智能翻译助手   │com.qizhi.trans│12-22    │8条     │➡ │ │
│  │ 账号: 账号B     │               │15:20    │        │  │ │
│  ├────────────────────────────────────────────────────────┤ │
│  │ 创意文案生成   │com.qizhi.copy │12-20    │12条    │➡ │ │
│  │ 账号: 账号A     │               │09:15    │        │  │ │
│  └────────────────────────────────────────────────────────┘ │
│  [上一页] [下一页]  显示 1-20 / 共 48 个                      │
└─────────────────────────────────────────────────────────────┘
```

**预期结果**：
- ✅ 清晰看到所有下架app
- ✅ 可以快速搜索定位
- ✅ 了解每个app有多少操作记录
- ✅ 一键进入详情页分析

---

### 场景2：单个app下架原因排查
**用户故事**：某个app昨天被下架了，我要分析下架前的所有操作

**操作流程**：
1. 在下架app列表中找到目标app
2. 点击右侧"➡"进入详情页
3. 看到该app从发布到下架的完整时间线
4. 分析每次操作的时间、版本、状态变化

**界面设计**：
```
┌─────────────────────────────────────────────────────────────┐
│  奇智AI写作 - 操作时间线                     [← 返回列表]     │
│  Bundle ID: com.qizhi.ai  |  下架时间: 2025-12-25 10:30     │
├─────────────────────────────────────────────────────────────┤
│  账号信息                                                     │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 开发者账号: account@example.com                       │   │
│  │ 账号来源: 🔴 代理11号（账号提供者）                    │   │
│  │ 账号状态: ⚠️ 账号被关停                                │   │
│  │ 账号到期: 2025-12-20（已过期）                         │   │
│  │ 注册地: 中国                                           │   │
│  │ 质量标记: 🔴 秒挂过、没开广告被下架                     │   │
│  │ 该账号下产品数: 12个                                   │   │
│  └──────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  [🔄 刷新数据]  [📥 导出报告]                                │
├─────────────────────────────────────────────────────────────┤
│  操作时间线（共15条记录）                                     │
│                                                               │
│  ┌─ 2025-12-25 10:30 ──────────────────────────────────┐   │
│  │ ❌ APP被下架                                          │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌─ 2025-12-20 14:20 ──────────────────────────────────┐   │
│  │ 🔄 更新任务 - v2.5.3                                  │   │
│  │ 状态: 正式包上架                                       │   │
│  │ 发布人: 张三                                           │   │
│  │ 备注: 修复bug，优化性能                                │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌─ 2025-12-15 09:30 ──────────────────────────────────┐   │
│  │ 🔄 更新任务 - v2.5.2                                  │   │
│  │ 状态: 正式包上架                                       │   │
│  │ 发布人: 李四                                           │   │
│  │ 备注: 添加新功能                                       │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌─ 2025-11-20 10:00 ──────────────────────────────────┐   │
│  │ 🚀 首次发布 - v1.0.0                                  │   │
│  │ 状态: 正式包上架                                       │   │
│  │ 发布人: 王五                                           │   │
│  │ 发布类型: 正式包                                       │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

**分析维度**：
- 📅 **时间间隔分析**：最后一次更新到下架的时间间隔
- 📊 **更新频率分析**：上架期间的更新频率
- 👤 **操作人分析**：是否有特定操作人的操作后下架
- 📝 **版本分析**：下架前的版本号和更新内容
- 🔐 **账号风险分析**：⭐ 新增
  - 账号来源风险（代理账号 vs 自注册账号）⭐⭐
  - 账号是否到期/被关停
  - 账号质量标记（是否有历史问题）
  - 账号下其他产品是否也下架
  - 注册地是否高风险
  - 同一来源的账号下架率统计

**预期结果**：
- ✅ 看到完整的操作时间线
- ✅ 快速定位下架前的最后操作
- ✅ 分析可能的下架原因
- ✅ 可以导出分析报告

---

### 场景3：批量对比分析（可选功能）
**用户故事**：本月有多个app下架，想找出共同规律

**操作流程**：
1. 在列表页勾选多个下架app（按住Ctrl多选）
2. 点击"批量对比"按钮
3. 看到横向对比视图

**界面设计**：
```
┌─────────────────────────────────────────────────────────────┐
│  批量对比分析（3个app）                      [← 返回列表]     │
├─────────────────────────────────────────────────────────────┤
│  共同特征分析：                                               │
│  - 所有app都在下架前1-3天进行了更新                          │
│  - 2个app最后更新版本号为2.5.3                               │
│  - 3个app都由同一个账号发布                                   │
│                                                               │
│  ┌──────────┬──────────┬──────────┬──────────┐              │
│  │          │ 奇智AI   │ 智能翻译 │ 创意文案 │              │
│  ├──────────┼──────────┼──────────┼──────────┤              │
│  │下架时间  │12-25     │12-22     │12-20     │              │
│  │更新次数  │15次      │8次       │12次      │              │
│  │最后版本  │v2.5.3    │v2.5.3    │v2.5.2    │              │
│  │存活时长  │35天      │28天      │42天      │              │
│  └──────────┴──────────┴──────────┴──────────┘              │
└─────────────────────────────────────────────────────────────┘
```

**预期结果**：
- ✅ 横向对比多个app的数据
- ✅ 自动识别共同特征
- ✅ 找出潜在的风险规律

---

## 📝 讨论记录

### 讨论1：功能定位和位置（2025-12-30）
**参与人**：用户

**确认内容**：
1. ✅ "下架排查"和"下架监控"是完全不同的功能
   - 下架排查 = 事后分析工具
   - 下架监控 = 实时监控工具
2. ✅ 前后端都升级成独立模块
3. ✅ 位置在侧边栏设置菜单项上方
4. ✅ 核心功能是：从明道云数据库获取操作记录排查下架原因

---

### 讨论2：取数逻辑和数据源（2025-12-30）
**参与人**：用户

**确认内容**：
1. ✅ **取数逻辑**：
   - 从"账号上的产品"表筛选App状态为"APP被下架"的记录
   - 通过bundle_id关联查询"App生产发布"表和"App更新任务"表
   - 按发布时间排序，形成完整操作时间线

2. ✅ **数据源定位**：
   - "账号上的产品"表：在"二维奇智"应用下
   - "App更新任务"表：在"二维奇智"应用下
   - "App生产发布"表：在"App工厂"应用下

3. ✅ **关键字段映射**：
   - 已确认"账号上的产品"表和"App更新任务"表的所有关键字段ID
   - "App生产发布"表需要后续配置MCP访问权限后查询

**待解决问题**：
- ⚠️ 需要配置"App工厂"应用的MCP访问权限
- ⚠️ 确认"App生产发布"表的完整字段结构

**下一步**：
- 设计界面原型
- 确认展示维度优先级
- 是否需要批量对比功能

---

### 讨论3：账号信息关联（2025-12-30）
**参与人**：用户

**需求**：
- 获取每条下架记录关联的苹果开发者账号信息
- 用于分析下架是否与账号异常相关

**确认内容**：
1. ✅ **数据可查询**：
   - "苹果开发者账号"表（`640adea9c04c8d453ff1ce52`）可正常查询
   - 通过"账号上的产品"表的关联字段（`64341940fa601169896433f6`）获取

2. ✅ **关键账号字段**：
   - 账号状态（使用中/被关停/回收等）
   - 账号到期时间
   - 账号关停时间
   - 账号质量标记⭐（秒挂过、other过、没开广告被下架等）
   - 注册地
   - 该账号下的产品数量

3. ✅ **分析价值**：
   - 账号到期 → 可能直接导致app下架
   - 账号被关停 → 可能导致app下架
   - 账号质量标记 → 识别高风险账号
   - 注册地 → 不同地区风险不同

**实现方式**：
- 在Supabase的`removal_analysis`表中增加账号信息字段
- 在详情页展示账号信息卡片
- 在分析维度中增加"账号风险分析"

**下一步**：
- 界面评审
- 开始开发

---

### 讨论5：App工厂应用API访问测试（2025-12-31）
**参与人**：用户、AI助手

**问题背景**：
- MCP配置"hap-mcp-App工厂"始终返回"二维奇智"应用
- 无法通过MCP工具访问"App生产发布"表

**解决过程**：
1. ⚠️ MCP工具方式失败
   - 尝试配置"hap-mcp-App工厂"的MCP
   - 工具调用始终返回"二维奇智"应用
   - 无法访问目标表

2. ✅ 直接API调用成功
   - 编写测试脚本直接调用明道云API
   - 测试多种API端点路径
   - **成功找到正确端点**：`https://api.mingdao.com/v2/open/worksheet/getWorksheetInfo`

**技术方案确认**：
```javascript
// 正确的API调用方式
const response = await fetch('https://api.mingdao.com/v2/open/worksheet/getWorksheetInfo', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    appKey: '2b3688e350d918d5',
    sign: 'YzE5N2M3MjczOTJmYTU2OWU3OGY3ZjFkYTc0ODczYzk4MzU5YTA0ZjkyMzM5ZDMwMGIyOTQ5YjcxZDI1OTg5NA==',
    worksheetId: '65612ddfc96f80bfabe5df2e'
  })
});
```

**成功结果**：
- ✅ 成功读取"App生产发布"表结构
- ✅ 获取完整的字段列表（共100+个字段）
- ✅ 确认用户要求的关键字段都存在：
  - 生产人（`6810850325726172e2468246`）
  - 广告代码版本（`6655a94ca87340a9754f7c41`）
  - 发布地点（`64cdf3e1784014033c3348d8`）
  - 版本号（`64b168be624fef0d46c11068`）
  - Bundle id（`64b168be624fef0d46c1105b`）

**实现决策**：
- ✅ 在后端同步服务中使用直接API调用方式（不依赖MCP工具）
- ✅ 统一使用 `https://api.mingdao.com/v2/open/` 系列API
- ✅ appKey和sign作为body参数传递

**下一步**：
- 设计Supabase数据库表结构
- 实现完整的数据同步逻辑
- 开始前后端开发

---

### 讨论6：关联字段查询操作符确认（2025-12-31）
**参与人**：用户、AI助手

**问题背景**：
- 查询"App更新任务"表时，需要通过"产品"关联字段过滤记录
- 测试bundle_id `com.f9g0h1i2j3.IlIIll` 应该有5条记录（1条发布+4条更新）
- 但实际只同步到1条，更新记录未能正确过滤

**测试过程**：
1. ❌ **方案1**: `operator: 'rceq'`, `value: productRowId`
   - 结果：返回100条记录（total=986）
   - 结论：filter完全未生效

2. ❌ **方案2**: `operator: 'in'`, `value: [productRowId]`
   - 结果：返回0条记录
   - 结论：操作符或值格式不对

3. ❌ **方案3**: `operator: 'contains'`, `value: [productRowId]`
   - 结果：返回0条记录
   - 结论：操作符或值格式不对

4. ✅ **方案4**: `operator: 'eq'`, `value: productRowId`
   - 结果：返回4条记录
   - 结论：**这是正确的方式！**

**正确方案**：
```typescript
{
  type: 'condition',
  field: '产品关联字段ID',
  operator: 'eq',      // ✅ 关联字段使用 eq 操作符
  value: 'rowid字符串'  // ✅ 直接传字符串，不用数组
}
```

**技术结论**：
- ✅ 明道云V3 API中，**关联字段（Relation）查询使用 `eq` 操作符 + 字符串值**
- ✅ 不要使用数组形式 `[productRowId]`
- ✅ 不要使用 `rceq`、`in`、`contains` 等操作符

**实施变更**：
- 已修复 `app-removal-investigation-service.ts` 中的 `syncUpdateRecords` 方法
- 已在 `test-service.ts` 中实现多方案测试逻辑

**验证结果**：
- ✅ `com.f9g0h1i2j3.IlIIll` 成功返回5条记录（1条发布+4条更新）

---

### 讨论4：账号来源字段确认（2025-12-30）
**参与人**：用户

**需求**：
- 确认"账号来源"字段是否可读取
- 用户强调这个字段对需求很重要

**验证结果**：
1. ✅ **字段完全可读**：
   - 账号来源（Relation字段）：`6435534e05108c17907c9766`
   - 账号来源名称（Lookup字段）：`64f0050bfe6380ec34433b31`
   - 实测数据：成功读取到"代理11号"等来源信息

2. ✅ **数据结构**：
   ```json
   {
     "zhly": [{"sid": "xxx", "name": "代理11号"}],
     "zhlymc": "代理11号"  // 直接显示名称
   }
   ```

3. ✅ **关联表信息**：
   - "账号来源"关联到"合作人员"表（`64340cf71c0252233e96336c`）
   - 包含：名称、类型（账号提供者/经常合作等）、业务类型

4. ✅ **分析价值**：
   - 识别账号质量和风险等级⭐⭐
   - 不同来源的下架率差异分析
   - 优化账号采购策略
   - 快速溯源问题账号

**实现方式**：
- 在Supabase的`removal_analysis`表中增加`account_source`和`account_source_type`字段
- 在界面中突出显示账号来源信息
- 在分析维度中增加"账号来源风险分析"
- 在统计面板中增加"按来源统计"功能

**重要性确认**：
- 用户明确表示这个字段对需求很重要 ✅
- 账号来源是识别风险的关键维度
- 必须在MVP阶段就实现

---

## 🚀 开发计划

### 前置条件
- [x] ✅ 配置"App工厂"应用的MCP访问权限
- [x] ✅ 确认"App生产发布"表的字段结构
- [x] ✅ 界面原型评审通过

---

### 阶段1：后端数据同步（核心）✅ 已完成
**目标**：实现从明道云同步下架app数据到Supabase

**开发任务**：
- [x] ✅ 创建Supabase新表
  - [x] `removed_apps` 表（下架app基本信息）
  - [x] `operation_records` 表（操作记录）
  - [x] `ri_developer_accounts` 表（开发者账号信息）
  - [x] `removal_investigation_sync_logs` 表（同步日志）
  - [x] `app_removal_analysis` 表（下架原因分析）⭐
- [x] ✅ 实现明道云数据同步服务
  - [x] 同步"账号上的产品"表的下架记录（1373条）
  - [x] 同步"App更新任务"表的更新记录（986条）
  - [x] 同步"App生产发布"表的发布记录（2827条）
  - [x] 同步开发者账号信息和账号来源
- [x] ✅ 实现数据处理和排序逻辑
  - [x] 按bundle_id关联数据
  - [x] 按时间排序操作记录
  - [x] 提取关键字段（版本号、广告代码版本、发布地点、生产人）⭐
- [x] ✅ 创建后端API端点
  - [x] `GET /api/removal-investigation/apps` - 获取下架app列表
  - [x] `GET /api/removal-investigation/apps/:bundleId/timeline` - 获取操作时间线
  - [x] `POST /api/removal-investigation/sync` - 触发全量同步
  - [x] `POST /api/removal-investigation/sync-incremental` - 触发增量同步⭐
  - [x] `GET /api/removal-investigation/sync-status` - 获取同步状态
  - [x] `GET /api/removal-investigation/apps/:bundleId/analysis` - 获取分析内容⭐
  - [x] `POST /api/removal-investigation/apps/:bundleId/analysis` - 保存分析内容⭐
- [x] ✅ 实现定时同步任务
  - [x] 每天凌晨3点自动执行增量同步

**完成标准**：
- ✅ 能成功从明道云同步下架app数据（1373条）
- ✅ 能正确关联并排序操作记录
- ✅ API端点返回正确的数据结构
- ✅ 定时任务正常运行
- ✅ 增量同步性能优化（从20分钟降到30秒）⭐

**实际完成时间**：2025-12-31

---

### 阶段2：前端界面开发（核心）✅ 已完成
**目标**：实现下架排查的用户界面

**开发任务**：
- [x] ✅ 添加侧边栏菜单项
  - [x] "下架排查"入口（设置菜单项上方）
- [x] ✅ 开发列表页
  - [x] 下架app列表展示
  - [x] 搜索功能（App名称、Bundle ID）
  - [x] 分页功能（每页20条）
  - [x] "增量同步"和"全量同步"按钮⭐
  - [x] 最后同步时间显示
- [x] ✅ 开发详情页
  - [x] 操作时间线展示
  - [x] 按时间倒序排列
  - [x] 区分操作类型（首次发布🚀/更新🔄）
  - [x] 展示关键信息（时间、版本、广告代码版本、操作人、发布地点、备注）⭐
  - [x] 账号信息卡片展示
  - [x] "刷新数据"按钮
  - [x] "APP下架原因分析和猜测"模块⭐
- [x] ✅ 数据加载和错误处理
  - [x] Loading状态
  - [x] 错误提示
  - [x] 空数据提示
  - [x] 同步进度提示

**完成标准**：
- ✅ 界面符合设计原型
- ✅ 交互流畅，响应快速
- ✅ 移动端适配良好
- ✅ 错误处理完善

**实际完成时间**：2025-12-31 ~ 2026-01-01

---

### 阶段3：功能增强（优先级中）
**目标**：增加辅助功能，提升用户体验

**开发任务**：
- [ ] 导出功能
  - [ ] 导出单个app的操作报告（PDF/Excel）
  - [ ] 批量导出多个app的数据
- [ ] 数据分析
  - [ ] 自动计算存活时长
  - [ ] 自动计算更新频率
  - [ ] 高亮下架前的最后操作
  - [ ] 账号来源风险分析⭐
    - [ ] 统计不同账号来源的下架率
    - [ ] 高亮高风险账号来源
    - [ ] 账号来源分布统计
- [ ] 筛选和排序
  - [ ] 按下架时间筛选
  - [ ] 按开发者账号筛选
  - [ ] 按存活时长排序
- [ ] 统计面板
  - [ ] 总下架数量
  - [ ] 本月下架数量
  - [ ] 平均存活时长
  - [ ] 最常见下架原因（如果能分析出）
  - [ ] 按账号来源统计下架数量⭐
  - [ ] 高风险账号来源TOP3

**完成标准**：
- ✅ 导出功能正常
- ✅ 分析数据准确
- ✅ 筛选和排序符合预期
- ✅ 统计面板数据正确

---

### 阶段4：高级功能（可选）
**目标**：提供更深入的分析能力

**开发任务**：
- [ ] 批量对比功能
  - [ ] 多选下架app
  - [ ] 横向对比视图
  - [ ] 共同特征识别
- [ ] 风险预警
  - [ ] 基于历史数据识别高风险操作
  - [ ] 在更新时提示潜在风险
- [ ] 数据可视化
  - [ ] 下架趋势图
  - [ ] 操作频率分布图
  - [ ] 版本更新路径图

**完成标准**：
- ✅ 批量对比逻辑正确
- ✅ 风险识别准确
- ✅ 图表展示清晰

---

### 时间估算（初步）

| 阶段 | 预计时间 | 依赖条件 |
|------|----------|----------|
| 阶段1 | 3-5天 | MCP权限配置完成 |
| 阶段2 | 3-4天 | 阶段1完成 |
| 阶段3 | 2-3天 | 阶段2完成 |
| 阶段4 | 4-5天 | 根据需求决定是否开发 |

**总计**：8-12天（不含阶段4）

---

## 📖 使用指南

### 首次使用

1. **访问系统**
   - 打开系统，点击侧边栏的**"下架排查"**菜单（位于"设置"上方）

2. **初始化数据**
   - 点击右上角的**"🔄 全量同步"**按钮
   - 等待20-30分钟，系统会同步所有下架App数据（1373条）
   - 同步完成后，左侧会显示所有下架的App列表

### 日常使用

#### 1. 查看下架App列表
- 从左侧列表浏览所有下架的App
- 可以看到App名称、Bundle ID、账号、下架时间、操作记录数量
- 使用顶部搜索框快速查找（支持App名称和Bundle ID）

#### 2. 查看操作时间线
- 点击左侧列表中的任意App
- 右侧会显示该App的完整操作时间线
- 时间线包含：
  - 🚀 **首次发布记录**（绿色标记）
  - 🔄 **更新记录**（蓝色标记）
  - ❌ **下架记录**（红色标记）
- 每条记录显示：
  - ⏰ 操作时间
  - 📦 版本号
  - 📢 广告代码版本⭐
  - 👤 操作人员（生产人/发布人）
  - 📍 发布地点⭐
  - 💬 备注信息

#### 3. 分析下架原因⭐
- 在详情页中找到**"APP 下架原因分析和猜测"**模块
- 在文本框中输入对下架原因的分析
- 点击**"保存"**按钮保存分析内容
- 分析内容会显示：
  - 创建人
  - 更新人
  - 最后更新时间
- 支持多次编辑和更新

#### 4. 查看账号信息
- 详情页顶部会显示**"账号信息"**卡片
- 包含：
  - 开发者账号邮箱
  - 账号来源（如"代理11号"）⭐⭐
  - 账号状态（使用中/被关停等）
  - 账号到期时间
  - 注册地
  - 质量标记（秒挂过、other过等）
  - 该账号下的产品数量

#### 5. 日常同步
- **工作流程**：发现App下架 → 记录到明道云 → 手动点击**"⚡ 增量同步"**按钮
- 增量同步会自动识别"新增的下架App"（明道云有但Supabase没有的）
- 只同步这些新增App的操作记录，速度很快（< 30秒）
- 页面顶部会显示"最后同步时间"

### 同步策略选择

**日常使用 → 增量同步**：
- 点击**"⚡ 增量同步"**按钮
- 只同步最近1天新增的App
- 耗时 < 30秒
- 推荐每天使用

**数据修复 → 全量同步**：
- 点击**"🔄 全量同步"**按钮
- 同步所有1373条App记录
- 耗时 20-30分钟
- 适用于首次使用或数据修复

### 搜索功能
- 在顶部搜索框中输入关键词
- 支持搜索：
  - App名称（模糊匹配）
  - Bundle ID（模糊匹配）
- 实时过滤列表结果

### 数据量说明
- 📊 **下架App总数**：1373个
- 📊 **发布记录**：2827条
- 📊 **更新记录**：986条
- 📊 **开发者账号**：数百个

---

## 🚀 部署指南

### 环境要求
- Node.js 16+
- PostgreSQL 14+（Supabase）
- 明道云API访问权限

### 环境变量配置

```bash
# 明道云 - 二维奇智应用（App更新任务表）
HAP_APP_KEY=9990f999f7a61d8d
HAP_SIGN=YWI0NGM5ZTNjYTg0MGZiNzI4MmQxMjMyOWE0MTg0YjgwY2Y2NDUxYzU0MzM4NmYzZGY2ZTdiNzI2NDI4MWYzNw==

# 明道云 - App工厂应用（App生产发布表）
HAP_APP_KEY_PRODUCTION_RELEASES=61e0dd24a4622a7b
HAP_SIGN_PRODUCTION_RELEASES=ZDllNGExYWVmNGMyNTFkNWU3ODQ3NTgxNjE1MzIyNTlmZDQ2MmI2ZjZmZGE0Nzc0YmFmMzZlMjNlODUyNzk5Nw==

# 工作表ID
HAP_WORKSHEET_PRODUCTS=643418197f0301fb51750f00
HAP_WORKSHEET_ACCOUNTS=640adea9c04c8d453ff1ce52
HAP_WORKSHEET_PRODUCTION_RELEASES=65612ddfc96f80bfabe5df2e
HAP_WORKSHEET_UPDATE_TASKS=640ab32a56058b3df8803af2

# Supabase
SUPABASE_URL=your_supabase_url
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

### 部署步骤

#### 1. 数据库初始化
在 Supabase Dashboard 的 SQL Editor 中执行：
```bash
database-removal-investigation.sql
```

这将创建5张表：
- `removed_apps`
- `operation_records`
- `ri_developer_accounts`
- `removal_investigation_sync_logs`
- `app_removal_analysis`

#### 2. 编译后端代码
```bash
cd fastlane-agent
npm install
npm run build
```

#### 3. 启动后端服务
```bash
# 使用 PM2（推荐）
pm2 start dist/server.js --name fastlane-agent

# 或直接启动
npm start
```

服务启动时会自动：
- ✅ 初始化下架排查服务
- ✅ 启动定时同步任务（每天凌晨3点）

#### 4. 部署前端
```bash
cd fastlane-ui
npm install
npm run build
```

如果使用 Vercel/Zeabur，推送代码后会自动部署。

### 验证部署

1. **检查后端服务**
```bash
curl http://localhost:3000/health
```

2. **检查同步功能**
```bash
curl -X POST http://localhost:3000/api/removal-investigation/sync-incremental
```

3. **访问前端**
- 打开浏览器访问系统
- 点击"下架排查"菜单
- 执行一次增量同步
- 验证数据显示正常

### 故障排查

#### 同步失败
**检查项**：
1. 环境变量是否正确配置
2. Supabase 是否可访问
3. 明道云 API 是否返回错误

**日志位置**：
- 后端控制台输出详细日志
- 查看 `removal_investigation_sync_logs` 表

#### 数据不显示
**检查项**：
1. 是否已执行首次同步
2. 检查 `removed_apps` 表是否有数据
3. 检查浏览器控制台错误

#### 时间线为空
**可能原因**：
- 该App在明道云中没有发布/更新记录
- Bundle ID 不匹配
- 数据同步时出现错误

**解决方法**：
- 重新触发同步
- 检查 `operation_records` 表

---

## 📋 需求总结

### 核心功能确认

✅ **已明确的核心需求**：
1. 独立的"下架排查"模块（前后端独立）
2. 位置：侧边栏设置菜单项上方
3. 数据来源：明道云三个表的关联查询
4. 主要功能：展示下架app的完整操作时间线
5. 界面：列表页 + 详情页（时间线）

✅ **技术方案确认**：
1. 从明道云同步数据到Supabase（包含账号信息）
2. 后端API提供数据查询
3. 前端React组件展示
4. 支持手动同步和定时自动同步

✅ **数据关联确认**：
1. 下架app → App生产发布记录（首次发布）
2. 下架app → App更新任务记录（所有更新）
3. 下架app → 苹果开发者账号信息⭐（账号风险分析）

✅ **开发优先级**：
- **P0（必须）**：阶段1-2（后端同步 + 前端展示）
- **P1（重要）**：阶段3（功能增强）
- **P2（可选）**：阶段4（高级功能）

### 待处理事项

⚠️ **前置条件**：
- [ ] 配置"App工厂"应用的MCP访问权限
- [ ] 确认"App生产发布"表的字段结构

✅ **已确认**：
- [x] "账号上的产品"表可以关联到"苹果开发者账号"表
- [x] "苹果开发者账号"表的字段结构已查询
- [x] 账号信息可以有效帮助分析下架原因
- [x] "账号来源"字段完全可读，数据质量良好⭐⭐
- [x] "账号来源"是识别风险的关键维度，必须实现

❓ **待确认细节**：
- 导出报告的具体格式（PDF还是Excel？包含哪些内容？）
- 是否需要权限控制（谁可以查看下架排查？）
- 是否需要操作日志（记录谁查看了哪些下架app？）

### 下一步行动

1. **配置MCP权限** → 用户操作
2. **评审界面设计** → 需要确认界面原型是否符合预期
3. **开始开发** → 按阶段1→2→3→4的顺序进行

---

## 📋 附录

### 相关文档
- [PRD 5.0 - 下架监控关联对比功能](./PRD5.0.md)
- [PRD 4.0 - 目标包监控功能](./PRD4.0.md)
- [PRD 3.0 - 下架监控功能](./PRD.md)

### 更新历史
- **2025-12-30**：创建文档，记录初步讨论内容
- **2025-12-30**：确认取数逻辑（三个表关联）
- **2025-12-30**：确认账号信息关联和字段结构
- **2025-12-30**：完成技术方案设计和界面原型
- **2025-12-30**：确认"账号来源"字段可读性和重要性⭐
- **2025-12-30**：需求讨论完成，状态更新为"待开发"
- **2025-12-31**：完成阶段1开发 - 后端数据同步服务
- **2025-12-31**：完成数据库表创建（5张表）
- **2025-12-31**：实现全量同步功能（1373条App记录）
- **2025-12-31**：实现增量同步功能（性能优化40倍）⭐
- **2025-12-31**：验证关键字段：版本号、广告代码版本、发布地点、生产人⭐
- **2025-12-31**：完成阶段2开发 - 前端界面
- **2025-12-31**：实现列表页、详情页、时间线视图
- **2025-12-31**：实现搜索、分页功能
- **2026-01-01**：新增"APP下架原因分析和猜测"功能⭐
- **2026-01-01**：部署上线，状态更新为"已上线"✅
- **2026-01-01**：整合所有实现文档到PRD，删除临时文档
- **2026-01-01**：修改增量同步逻辑，改为同步"所有未同步的App"而非"最近1天"⭐
- **2026-01-01**：移除自动定时同步功能，改为纯手动触发（符合事后排查场景）

---

## 🔐 版本 6.1 - RBAC 权限系统

**发布日期**: 2026-01-01  
**状态**: ✅ 已上线  
**功能类型**: 系统级功能 - 权限管理

### 功能概述

为系统添加了完整的基于角色的访问控制（RBAC）功能，支持两种角色：

#### 👨‍💼 管理员 (Administrator)
- ✅ 访问所有功能和页面
- ✅ 管理团队成员角色
- ✅ 配置全局监控服务
- ✅ 无任何功能限制

#### 👨‍💻 操作员 (Operator)
- ✅ 访问核心发布功能：
  - 发布看板 (`/overview`)
  - 发布操作 (`/projects`)
  - 发布历史 (`/releases`)
  - 设置 (`/settings`)
- ❌ 无法访问高级功能：
  - 关联对比、下架排查、目标包监控
  - 团队管理、统计报表等
- ⚙️ 监控设置：
  - "下架状态自动监控"默认关闭，可手动开启
  - "目标包自动监控"默认关闭，可手动开启

### 核心实现

#### 1. 数据库层
- ✅ 新增 `user_profiles` 表存储用户角色和配置
- ✅ RLS (Row Level Security) 策略保护数据安全
- ✅ 自动触发器：新用户自动创建 profile（默认为操作员）
- ✅ 第一个用户自动设置为管理员

#### 2. 前端层
- ✅ 侧边栏菜单动态过滤（基于角色）
- ✅ 路由权限保护（`RoleGuard` 组件）
- ✅ 设置页面分级（管理员配置全局，操作员配置个人）
- ✅ 团队管理页面（仅管理员可访问）
- ✅ Store 持久化（刷新页面保持登录状态）
- ✅ Session 验证优化（避免每次切换页面都检查）

#### 3. 后端层
- ✅ 权限验证中间件（`auth-middleware.ts`）
- ✅ `requireAuth()` - 验证用户登录
- ✅ `requireAdminAuth` - 验证管理员权限

### 技术特性

#### 安全特性
1. **三层权限防护**
   - 数据库层：RLS 策略
   - 后端层：API 中间件
   - 前端层：路由 + 组件守卫

2. **防止权限提升**
   - 用户只能修改自己的配置
   - 只有管理员可以修改他人角色
   - 系统保护：至少保留一个管理员

3. **会话管理优化**
   - Store 持久化到 localStorage
   - 刷新页面快速恢复登录状态
   - Session 超时处理（15秒）

#### 性能优化
- ✅ 首次访问：需要验证 session（可能15秒）
- ✅ 页面切换：秒开（复用已登录状态）
- ✅ 刷新页面：秒开（从 localStorage 恢复）

### 使用流程

#### 首次部署
1. 执行数据库迁移脚本 `database-rbac-migration.sql`
2. 首个注册用户自动成为管理员
3. 或使用 `set-admin.sql` 手动设置管理员

#### 日常使用
1. **管理员**：
   - 在"团队管理"页面分配用户角色
   - 在"设置"页面配置全局监控服务

2. **操作员**：
   - 访问核心发布功能
   - 在"设置"页面配置个人监控偏好

### 新增文件

**数据库**：
- `database-rbac-migration.sql` - 数据库迁移脚本
- `set-admin.sql` - 手动设置管理员脚本
- `fix-rls-policies.sql` - RLS 策略修复脚本

**后端**：
- `fastlane-agent/src/auth-middleware.ts` - 权限验证中间件

**前端**：
- `fastlane-ui/hooks/use-auth.ts` - 权限管理 Hook
- `fastlane-ui/components/role-guard.tsx` - 路由权限保护
- `fastlane-ui/app/(dashboard)/team/page.tsx` - 团队管理页面

**文档**：
- `RBAC-DEPLOYMENT.md` - 完整部署指南

### 修改文件
- `fastlane-ui/lib/types.ts` - 添加角色类型定义
- `fastlane-ui/lib/store.ts` - 添加持久化和角色状态
- `fastlane-ui/components/auth-guard.tsx` - 优化登录验证逻辑
- `fastlane-ui/components/sidebar.tsx` - 菜单权限过滤
- `fastlane-ui/app/(dashboard)/settings/page.tsx` - 设置页面分级
- `fastlane-ui/app/(dashboard)/layout.tsx` - 路由权限保护
- `fastlane-ui/app/page.tsx` - 根路径重定向优化
- `fastlane-ui/app/login/page.tsx` - 登录重定向逻辑

### 部署要求
1. ✅ 执行数据库迁移
2. ✅ 配置 Supabase 环境变量
3. ✅ 重新构建前端：`npm run build`
4. ✅ 重启服务

### 已知问题和优化
- ✅ **已解决**：刷新页面跳转到登录（通过 Store 持久化）
- ✅ **已解决**：首次访问超时问题（15秒超时 + 快速验证）
- ✅ **已解决**：页面切换慢（只在首次检查，后续秒开）
- ⚠️ **待优化**：Supabase 连接慢（可能需要 CDN 或边缘函数）

### 更新记录
- **2026-01-01 上午**：完成 RBAC 核心功能开发
- **2026-01-01 下午**：优化认证流程，解决刷新跳转问题
- **2026-01-01 下午**：优化页面切换性能，实现秒开
- **2026-01-01 晚上**：部署上线并测试通过 ✅

