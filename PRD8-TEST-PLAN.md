# PRD 8.0 外部审核监控 - 测试计划

## 测试环境准备

### 前置条件

1. ✅ 数据库迁移已执行（`source` 字段已添加）
2. ✅ 环境变量已配置（两张明道云表的认证信息）
3. ✅ fastlane-agent 服务已启动
4. ✅ fastlane-ui 前端已启动

### 测试数据

**明道云当前数据**（2026-01-17）：
- App生产发布表：3条"正式包审核中"记录
- App更新任务表：3条"正式包审核中"记录
- **总计**: 6条待同步记录

## 测试用例

### 测试1：后端服务单元测试

**目的**: 验证同步服务能正确读取明道云数据并插入数据库

**步骤**:
```bash
cd fastlane-agent
npx ts-node scripts/test-external-release-sync.ts
```

**预期结果**:
```
✅ 同步成功
   - 新增: 6 条（首次运行）
   - 已存在: 0 条
   - 失败: 0 条
```

**验证点**:
- [ ] 成功读取"App生产发布表"（3条）
- [ ] 成功读取"App更新任务表"（3条）
- [ ] Bundle ID 正确获取（生产发布表直接读取，更新任务表关联查询）
- [ ] Apple API Key 正确获取
- [ ] 用户名正确提取（白欣语、王欣怡、赵志鹏）

### 测试2：去重逻辑测试

**目的**: 验证重复记录不会被再次插入

**步骤**:
1. 第一次运行同步（应该插入6条）
2. 第二次运行同步（应该全部跳过）

**预期结果**（第二次运行）:
```
✅ 同步成功
   - 新增: 0 条
   - 已存在: 6 条
   - 失败: 0 条
```

**验证点**:
- [ ] 去重逻辑基于 `bundle_id + version`
- [ ] 已存在的记录不会重复插入
- [ ] 数据库中总记录数保持不变

### 测试3：API端点测试

**目的**: 验证API端点正常工作

**步骤**:
```bash
curl -X POST http://localhost:3000/api/releases/sync-external \
  -H "Content-Type: application/json"
```

**预期结果**:
```json
{
  "success": true,
  "data": {
    "newCount": 0,
    "existCount": 6,
    "failCount": 0,
    "failedApps": []
  }
}
```

**验证点**:
- [ ] API返回正确的JSON格式
- [ ] HTTP状态码为200
- [ ] 同步结果统计准确

### 测试4：前端UI测试（发布历史页面）

**目的**: 验证前端同步按钮和Toast提示

**步骤**:
1. 访问 `http://localhost:3001/releases`
2. 点击右上角"同步外部审核"按钮
3. 观察按钮状态变化
4. 等待同步完成
5. 查看Toast提示
6. 刷新页面查看列表

**预期结果**:
- [ ] 按钮显示"同步中..."并禁用
- [ ] 同步完成后显示Toast: "同步完成！新增: X条 | 已存在: Y条"
- [ ] 列表自动刷新，显示新增记录
- [ ] 新记录的监控状态为"已启用"（绿色眼睛图标）

### 测试5：前端UI测试（概览页面）

**目的**: 验证概览页面的同步功能

**步骤**:
1. 访问 `http://localhost:3001/overview`
2. 在"最近发布"模块点击"同步外部审核"按钮
3. 观察同步过程和结果
4. 查看"最近发布"列表是否包含新记录

**预期结果**:
- [ ] 同步按钮正常工作
- [ ] Toast提示正确显示
- [ ] "最近发布"列表自动刷新
- [ ] 新记录显示在列表顶部

### 测试6：部分失败场景测试

**目的**: 验证错误处理和失败反馈

**模拟方法**:
1. 在明道云中创建一条"正式包审核中"记录
2. 故意不填写 Bundle ID 或开发者账号关联
3. 执行同步

**预期结果**:
```
⚠️ 同步完成（部分失败）
✅ 新增: X条 | ℹ️ 已存在: Y条 | ❌ 失败: 1条

失败详情:
某App v1.0: 无法获取 Bundle ID 的账号配置
```

**验证点**:
- [ ] 失败记录不影响其他记录同步
- [ ] Toast显示详细的失败原因
- [ ] 失败信息包含App名称和版本号

### 测试7：审核监控集成测试

**目的**: 验证同步后的记录能被 ReviewMonitor 正常监控

**步骤**:
1. 执行同步，插入新记录
2. 等待 ReviewMonitor 下次运行（每小时），或手动刷新
3. 查看 `review_status` 是否更新

**手动刷新方法**:
- 在前端点击记录右侧的刷新按钮
- 或调用API: `POST /releases/{releaseId}/refresh-status`

**预期结果**:
- [ ] `review_status` 从 `WAITING_FOR_REVIEW` 更新为实际状态
- [ ] `last_checked_at` 时间戳更新
- [ ] 前端显示更新后的状态徽章

### 测试8：数据完整性验证

**目的**: 验证同步的数据完整且正确

**SQL查询**:
```sql
SELECT 
  app_name,
  version,
  bundle_id,
  apple_id,
  source,
  monitor_enabled,
  review_status,
  deployed_by,
  submitted_at,
  api_key_id,
  team_id
FROM releases 
WHERE source = 'manual'
ORDER BY submitted_at DESC;
```

**验证点**:
- [ ] 所有必需字段都有值（不为NULL）
- [ ] `source` 字段为 'manual'
- [ ] `monitor_enabled` 为 true
- [ ] `review_status` 为 'WAITING_FOR_REVIEW'
- [ ] `deployed_by` 包含中文姓名（不是UUID）
- [ ] `bundle_id` 格式正确（com.xxx.xxx）
- [ ] `api_key_id` 和 `team_id` 不为空

## 性能测试

### 同步性能

**测试场景**: 同步6条记录

**预期耗时**: 5-15秒

**监控指标**:
- 明道云API调用次数
- 数据库查询次数
- 总耗时

**优化建议**:
- 如果记录数量增多，考虑批量插入
- 缓存 Bundle ID 查询结果

## 回归测试

### 验证现有功能不受影响

**测试项**:
1. [ ] 通过 fastlane UI 发布仍然正常（`source = 'fastlane'`）
2. [ ] 审核监控对 fastlane 发布的记录仍然有效
3. [ ] 发布历史列表正常显示所有记录
4. [ ] 监控开关功能正常工作
5. [ ] 手动刷新审核状态功能正常

## 测试检查清单

### 后端
- [ ] 数据库迁移成功执行
- [ ] ExternalReleaseSync 服务正确初始化
- [ ] API端点 `/api/releases/sync-external` 可访问
- [ ] 同步逻辑正确处理两张明道云表
- [ ] 去重逻辑正确工作
- [ ] 错误处理机制有效

### 前端
- [ ] 发布历史页面显示"同步外部审核"按钮
- [ ] 概览页面显示"同步外部审核"按钮
- [ ] 按钮状态正确切换（同步中/正常）
- [ ] Toast提示信息准确
- [ ] 列表自动刷新

### 集成
- [ ] 同步后的记录出现在发布列表中
- [ ] ReviewMonitor 能正常监控同步的记录
- [ ] 审核状态能正常更新
- [ ] 监控开关对同步记录有效

## 已知限制

1. **build_number**: 固定为 "1"（明道云表未维护此字段）
2. **apple_id**: "App生产发布表"无此字段，设为空字符串
3. **用户映射**: 存储明道云用户名，无法关联到 Supabase 用户
4. **手动触发**: 需要用户手动点击同步，不支持自动定时同步

## 测试通过标准

- ✅ 所有单元测试通过
- ✅ 能成功同步明道云数据
- ✅ 去重逻辑正确工作
- ✅ 前端UI正常显示和交互
- ✅ 审核监控对同步记录有效
- ✅ 无编译错误和运行时错误
- ✅ 现有功能不受影响
